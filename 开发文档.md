# Vanction 编程语言开发文档

## 1. 项目概述

Vanction是一种编译型编程语言，通过将Vanction源代码编译为C++代码，然后使用GCC编译器编译为可执行文件。本文档详细描述了Vanction的架构设计、组件实现和开发流程，面向想要了解或扩展Vanction的开发者。

## 2. 架构设计

### 2.1 整体架构

Vanction编译器采用经典的编译器架构，分为以下几个主要阶段：

1. **词法分析**：将源代码转换为标记（Tokens）
2. **语法分析**：将标记转换为抽象语法树（AST）
3. **代码生成**：将AST转换为C++代码
4. **编译链接**：使用GCC将C++代码编译为可执行文件

### 2.2 组件关系

```
┌─────────────────┐    ┌──────────────┐    ┌────────────────────┐    ┌─────────────┐
│  词法分析器      │───▶│  语法分析器   │───▶│     代码生成器      │───▶│  GCC编译器   │
│  (lexer.cpp)    │    │ (parser.cpp) │    │(code_generator.cpp)│    └─────────────┘
└─────────────────┘    └──────────────┘    └────────────────────┘
        ▲                     ▲                     ▲
        │                     │                     │
        └───────────────────────────────────────────┘
                              │
                              ▼
                        ┌─────────────┐
                        │  错误处理    │
                        │  (error.cpp) │
                        └─────────────┘
                              │
                              ▼
                        ┌─────────────┐
                        │  模块管理    │
                        │(module_manager.cpp)│
                        └─────────────┘
```

## 3. 组件详细说明

### 3.1 词法分析器（Lexer）

#### 3.1.1 功能

词法分析器将源代码文本转换为一系列标记（Tokens），供语法分析器使用。每个标记包含类型和值信息。

#### 3.1.2 实现细节

- 文件：`src/lexer.cpp`和`src/lexer.h`
- 核心类：`Lexer`
- 核心方法：`getNextToken()`

#### 3.1.3 支持的标记类型

- **关键字**：`func`, `var`, `immut`, `if`, `else`, `for`, `while`, `do`, `return`, `class`, `extends`, `instance`, `super`, `try`, `happen`, `import`, `namespace`
- **运算符**：`+`, `-`, `*`, `/`, `=`, `==`, `!=`, `<`, `>`, `<=`, `>=`, `&`, `|`, `^`, `!`
- **分隔符**：`(`, `)`, `{`, `}`, `[`, `]`, `,`, `;`, `.`
- **字面量**：整数、浮点数、字符串、布尔值
- **标识符**：变量名、函数名、类名

### 3.2 语法分析器（Parser）

#### 3.2.1 功能

语法分析器将词法分析器生成的标记序列转换为抽象语法树（AST），表示源代码的结构和语义。

#### 3.2.2 实现细节

- 文件：`src/parser.cpp`和`src/parser.h`
- 核心类：`Parser`
- 核心方法：`parseProgram()`

#### 3.2.3 语法规则

Vanction使用递归下降解析法实现语法分析，支持以下语法规则：

- **程序结构**：由多个声明组成
- **声明**：函数声明、变量声明、类声明、命名空间声明、导入声明
- **表达式**：赋值表达式、二元表达式、函数调用、标识符、字面量等
- **语句**：表达式语句、if语句、循环语句、return语句、try-happen语句

#### 3.2.4 AST节点类型

- `Program`：程序根节点
- `FunctionDeclaration`：函数声明
- `VariableDeclaration`：变量声明
- `ClassDeclaration`：类声明
- `NamespaceDeclaration`：命名空间声明
- `ImportStatement`：导入声明
- `ExpressionStatement`：表达式语句
- `IfStatement`：if语句
- `ForLoopStatement`：for循环
- `WhileLoopStatement`：while循环
- `DoWhileLoopStatement`：do-while循环
- `ForInLoopStatement`：for-in循环
- `ReturnStatement`：return语句
- `TryHappenStatement`：try-happen语句
- `BinaryExpression`：二元表达式
- `AssignmentExpression`：赋值表达式
- `FunctionCall`：函数调用
- `Identifier`：标识符
- `Literal`：字面量（整数、浮点数、字符串、布尔值）
- `ListLiteral`：列表字面量
- `HashMapLiteral`：哈希表字面量

### 3.3 代码生成器（Code Generator）

#### 3.3.1 功能

代码生成器将AST转换为C++代码，然后使用GCC编译器编译为可执行文件。

#### 3.3.2 实现细节

- 文件：`src/code_generator.cpp`和`src/code_generator.h`
- 核心类：`CodeGenerator`
- 核心方法：`generateCode()`

#### 3.3.3 生成策略

- **类型映射**：将Vanction类型映射到C++类型
- **函数生成**：将Vanction函数转换为C++函数
- **类生成**：将Vanction类转换为C++类
- **表达式生成**：将Vanction表达式转换为C++表达式
- **语句生成**：将Vanction语句转换为C++语句

### 3.4 错误处理机制

#### 3.4.1 功能

提供统一的错误处理机制，支持多种错误类型和详细的错误信息。

#### 3.4.2 实现细节

- 文件：`src/error.cpp`和`src/error.h`
- 核心类：`VanctionError`（基类）和各种具体错误类

#### 3.4.3 错误类型

- `VanctionError`：所有错误的基类
- `DivideByZeroError`：除零错误
- `ValueError`：值错误
- `TypeError`：类型错误
- `MethodError`：方法错误
- `ImmutError`：常量修改错误
- `RangeError`：范围错误
- `ListIndexError`：列表索引错误
- `CError`：C++异常包装

### 3.5 模块管理

#### 3.5.1 功能

管理模块的加载和依赖关系，支持模块导入和命名空间。

#### 3.5.2 实现细节

- 文件：`src/module_manager.cpp`和`src/module_manager.h`
- 核心类：`ModuleManager`和`Module`
- 核心方法：`loadModule()`

### 3.6 运行时系统

#### 3.6.1 功能

提供运行时支持，包括类型系统、数据结构和内置函数。

#### 3.6.2 实现细节

- 文件：`src/main.cpp`（部分运行时功能）
- 核心数据结构：
  - `List`：动态数组实现
  - `HashMap`：哈希表实现
  - `Instance`：对象实例
  - `ClassDefinition`：类定义

#### 3.6.3 内置类型

- **整数**：int
- **浮点数**：double
- **字符串**：std::string
- **布尔值**：bool
- **列表**：List类
- **哈希表**：HashMap类
- **对象**：Instance类

#### 3.6.4 内置函数

- `System.print()`：输出内容
- `range()`：生成范围
- `type.int()`：转换为整数
- `type.float()`：转换为浮点数
- `type.string()`：转换为字符串

## 4. 构建系统

### 4.1 CMake配置

Vanction使用CMake作为构建系统，配置文件为`CMakeLists.txt`。

### 4.2 构建流程

1. **生成构建文件**：`cmake ..`
2. **编译项目**：`cmake --build .`
3. **运行测试**：`./build/Vanction <source_file.vn>`

### 4.3 依赖管理

- **CMake**：3.10或更高版本
- **MinGW-w64 GCC**：C++编译器
- **C++标准库**：C++17或更高版本

## 5. 核心数据结构

### 5.1 抽象语法树（AST）

AST是Vanction编译器的核心数据结构，用于表示源代码的结构和语义。每个AST节点对应源代码中的一个语法结构。

### 5.2 符号表

符号表用于存储变量、函数、类和命名空间的信息，在编译过程中用于类型检查和名称解析。

- **variables**：存储变量信息
- **constants**：存储常量信息
- **functions**：存储函数信息
- **namespaces**：存储命名空间信息
- **classes**：存储类信息

### 5.3 值类型系统

Vanction使用C++的variant类型实现动态类型系统：

```cpp
using Value = std::variant<int, char, std::string, bool, float, double, std::monostate, Instance*, ErrorObject*, List*, HashMap*>;
```

## 6. 编译流程

### 6.1 主流程

主函数位于`src/main.cpp`，负责协调整个编译过程：

1. **读取命令行参数**：获取源文件路径
2. **读取源文件**：将源代码读入内存
3. **词法分析**：调用`Lexer`生成标记
4. **语法分析**：调用`Parser`生成AST
5. **代码生成**：调用`CodeGenerator`生成C++代码
6. **编译链接**：使用`system()`调用GCC编译C++代码
7. **清理临时文件**：删除生成的C++临时文件

### 6.2 执行流程

在解释模式下（如执行函数声明），Vanction直接执行AST节点：

1. **执行函数声明**：`executeFunctionDeclaration()`
2. **执行语句**：`executeStatement()`
3. **执行表达式**：`executeExpression()`
4. **执行函数调用**：`executeFunctionCall()`

## 7. 错误处理流程

当在编译或运行过程中发生错误时，Vanction会抛出相应的错误对象：

1. **抛出错误**：使用`throw`关键字抛出`VanctionError`或其子类
2. **捕获错误**：在`try-happen`语句中捕获错误
3. **错误信息**：错误对象包含错误类型、文本和详细信息
4. **错误恢复**：根据错误类型进行相应的恢复操作

## 8. 测试框架

### 8.1 测试文件

测试文件位于`examples/test`目录下，包含各种测试用例：

- `hello_world.vn`：简单的Hello World程序
- `basic_arithmetic.vn`：基本算术运算
- `conditionals_loops.vn`：条件语句和循环
- `test_error_handling.vn`：错误处理机制
- `test_data_structures.vn`：数据结构使用
- `namespace_clas.vn`：命名空间和类

### 8.2 测试脚本

项目根目录下的`test_vanction.py`是一个简单的测试脚本，用于批量测试示例程序。

## 9. 扩展Vanction

### 9.1 添加新的语法特性

要添加新的语法特性，需要修改以下几个组件：

1. **词法分析器**：添加新的标记类型
2. **语法分析器**：添加新的语法规则和AST节点
3. **代码生成器**：添加新的代码生成逻辑
4. **运行时系统**：添加相应的运行时支持

### 9.2 添加新的内置函数

在`src/main.cpp`中的`initializeConstants()`函数或其他适当位置添加新的内置函数。

### 9.3 添加新的错误类型

在`src/error.h`中定义新的错误类，继承自`VanctionError`，然后在`src/error.cpp`中实现。

## 10. 调试技巧

### 10.1 启用调试模式

在`src/main.cpp`中设置`debugMode`为`true`，可以输出详细的调试信息：

```cpp
bool debugMode = true;
```

### 10.2 输出AST

在语法分析器中添加代码，输出生成的AST结构，帮助理解语法分析过程。

### 10.3 输出生成的C++代码

在代码生成器中添加代码，输出生成的C++代码，帮助调试代码生成过程。

### 10.4 使用GDB调试

使用GDB调试生成的可执行文件，查看运行时错误：

```bash
gdb ./output_executable
```

## 11. 性能优化

### 11.1 词法分析优化

- 使用更高效的标记生成算法
- 减少内存分配

### 11.2 语法分析优化

- 优化递归下降解析器的性能
- 使用缓存避免重复解析

### 11.3 代码生成优化

- 生成更高效的C++代码
- 优化变量和函数的命名

### 11.4 运行时优化

- 优化内置数据结构的实现
- 减少运行时类型检查的开销

## 12. 跨平台支持

### 12.1 Windows支持

Vanction已在Windows平台上测试通过，使用MinGW-w64 GCC编译器。

### 12.2 Linux/macOS支持

目前尚未在Linux/macOS上进行全面测试，但代码结构设计考虑了跨平台支持，主要需要修改以下部分：

- **路径处理**：使用跨平台的路径分隔符
- **系统调用**：使用跨平台的系统调用替代平台特定的实现
- **编译器路径**：根据平台自动查找GCC编译器

## 13. 开发流程

### 13.1 代码风格

- 使用C++17标准
- 缩进使用4个空格
- 类名使用PascalCase
- 函数名和变量名使用camelCase
- 常量名使用UPPER_SNAKE_CASE

### 13.2 提交规范

- 提交信息使用英文
- 简短描述修改内容
- 对于重大修改，添加详细的提交说明

### 13.3 分支管理

- `main`：主分支，包含稳定版本
- `dev`：开发分支，包含最新的开发代码
- 功能分支：用于开发特定功能

## 14. 未来计划

- [ ] 完善类型系统，支持静态类型检查
- [ ] 添加更多内置库和函数
- [ ] 支持更多平台（Linux、macOS）
- [ ] 添加调试器支持
- [ ] 优化编译速度和运行时性能
- [ ] 添加包管理系统
- [ ] 支持并发编程

## 15. 贡献指南

欢迎对Vanction进行贡献！以下是贡献的步骤：

1. Fork仓库
2. 创建功能分支
3. 实现功能或修复bug
4. 运行测试确保代码正确
5. 提交代码
6. 创建Pull Request

## 16. 联系方式

如有问题或建议，请通过GitHub Issues与我们联系。

## 17. 许可证

Vanction编程语言采用LGPL2.0许可证，详情请查看LICENSE文件。

---

**感谢您对Vanction的兴趣和贡献！** 🚀